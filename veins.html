<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NOUS PROTOCOL — Veins Core</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;}
#main{position:relative;width:100vw;height:100vh;}
#c{display:block;width:100%!important;height:100%!important;}
.scanline{position:absolute;inset:0;pointer-events:none;z-index:2;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.018) 3px,rgba(0,0,0,.018) 4px);}
.corner{position:absolute;width:22px;height:22px;z-index:5;}
.corner.tl{top:20px;left:20px;border-top:1px solid rgba(207,192,126,.4);border-left:1px solid rgba(207,192,126,.4);}
.corner.tr{top:20px;right:20px;border-top:1px solid rgba(207,192,126,.4);border-right:1px solid rgba(207,192,126,.4);}
.corner.bl{bottom:20px;left:20px;border-bottom:1px solid rgba(207,192,126,.4);border-left:1px solid rgba(207,192,126,.4);}
.corner.br{bottom:20px;right:20px;border-bottom:1px solid rgba(207,192,126,.4);border-right:1px solid rgba(207,192,126,.4);}
.hud{position:absolute;pointer-events:none;z-index:5;font-family:'DM Mono',monospace;}
.htl{top:36px;left:36px;}.htr{top:36px;right:36px;text-align:right;}
.hbl{bottom:36px;left:36px;}.hbr{bottom:36px;right:36px;text-align:right;}
.h-title{font-family:'Press Start 2P',monospace;font-size:13px;color:rgba(207,192,126,.92);
  letter-spacing:.1em;line-height:2;text-shadow:0 0 22px rgba(207,192,126,.5);}
.h-sub{font-size:8px;color:rgba(207,192,126,.38);letter-spacing:.22em;text-transform:uppercase;margin-top:4px;}
.h-hint{font-size:7px;color:rgba(207,192,126,.22);letter-spacing:.12em;margin-top:10px;line-height:2.6;}
.h-stat{font-size:8px;color:rgba(232,232,198,.45);letter-spacing:.14em;line-height:2.5;}
.h-stat b{color:rgba(207,192,126,.85);font-weight:400;}
#vitality{position:absolute;left:36px;top:50%;transform:translateY(-50%);width:178px;pointer-events:none;z-index:5;
  border:1px solid rgba(207,192,126,.15);background:rgba(0,0,0,.65);backdrop-filter:blur(4px);padding:14px 16px;}
.v-title{font-family:'Press Start 2P',monospace;font-size:6px;color:rgba(207,192,126,.7);letter-spacing:.12em;margin-bottom:14px;}
.v-row{font-family:'DM Mono',monospace;font-size:7px;color:rgba(232,232,198,.4);letter-spacing:.1em;line-height:1;margin-bottom:12px;}
.v-row b{color:rgba(207,192,126,.8);font-weight:400;display:block;font-size:9px;margin-top:2px;}
.v-bar{width:100%;height:2px;background:rgba(255,255,255,.06);margin-top:5px;overflow:hidden;}
.v-fill{height:100%;background:linear-gradient(90deg,rgba(207,192,126,.25),rgba(207,192,126,.9));transition:width .8s ease;}
#nodeinfo{position:absolute;right:36px;top:50%;transform:translateY(-50%);width:210px;z-index:5;pointer-events:none;
  border:1px solid rgba(207,192,126,.15);background:rgba(0,0,0,.65);backdrop-filter:blur(4px);
  padding:16px 18px;opacity:0;transition:opacity .35s ease;}
#nodeinfo.vis{opacity:1;}
.ni-name{font-family:'Press Start 2P',monospace;font-size:8px;letter-spacing:.1em;margin-bottom:12px;line-height:1.8;}
.ni-desc{font-family:'DM Mono',monospace;font-size:8px;color:rgba(232,232,198,.5);letter-spacing:.08em;line-height:1.9;margin-bottom:14px;white-space:pre-line;}
.ni-stat{font-family:'DM Mono',monospace;font-size:7px;color:rgba(207,192,126,.45);letter-spacing:.1em;line-height:2.3;white-space:pre;}
#flare-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Press Start 2P',monospace;font-size:9px;letter-spacing:.14em;
  text-align:center;line-height:2.4;pointer-events:none;z-index:10;
  opacity:0;transition:opacity .3s;text-shadow:0 0 20px currentColor;}
#flare-msg.show{opacity:1;}
.nlabel{position:absolute;font-family:'Press Start 2P',monospace;font-size:7px;letter-spacing:.08em;
  transform:translate(-50%,-50%);pointer-events:auto;cursor:pointer;z-index:6;white-space:nowrap;
  padding:4px 8px;text-shadow:0 0 10px currentColor;background:rgba(0,0,0,.55);
  border-bottom:1px solid currentColor;transition:opacity .25s,transform .25s;}
.nlabel:hover{transform:translate(-50%,-50%) scale(1.12)!important;}
#loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Press Start 2P',monospace;font-size:8px;color:rgba(207,192,126,.5);
  letter-spacing:.2em;z-index:20;text-align:center;line-height:2.5;}
.pring{position:absolute;top:50%;left:50%;border-radius:50%;pointer-events:none;z-index:1;
  animation:pring 4s ease infinite;transform:translate(-50%,-50%);}
.pring:nth-child(1){width:300px;height:300px;border:1px solid rgba(207,192,126,.045);}
.pring:nth-child(2){width:490px;height:490px;border:1px solid rgba(207,192,126,.024);animation-delay:1.3s;}
.pring:nth-child(3){width:680px;height:680px;border:1px solid rgba(207,192,126,.012);animation-delay:2.6s;}
@keyframes pring{0%{opacity:0;transform:translate(-50%,-50%) scale(.88)}20%{opacity:1}100%{opacity:0;transform:translate(-50%,-50%) scale(1.14)}}

/* ── BACK BUTTON ── */
#back-btn{
  position:absolute;top:22px;left:50%;transform:translateX(-50%);
  font-family:'Press Start 2P',monospace;font-size:6px;letter-spacing:.2em;
  color:rgba(207,192,126,.5);background:rgba(0,0,0,.72);
  border:1px solid rgba(207,192,126,.18);padding:8px 20px;
  cursor:pointer;z-index:15;display:flex;align-items:center;gap:10px;
  transition:all .2s;backdrop-filter:blur(8px);pointer-events:auto;
}
#back-btn:hover{color:rgba(207,192,126,.95);border-color:rgba(207,192,126,.45);}
#back-btn span{font-size:10px;line-height:1;}

/* ── INFO TRIGGER (bottom pulse) ── */
#info-trigger{
  position:absolute;bottom:0;left:0;right:0;
  display:flex;flex-direction:column;align-items:center;
  padding-bottom:18px;z-index:8;pointer-events:none;
}
#info-btn{
  font-family:'Press Start 2P',monospace;font-size:6px;letter-spacing:.2em;
  color:rgba(207,192,126,.35);background:transparent;border:none;
  display:flex;flex-direction:column;align-items:center;gap:6px;
  cursor:pointer;pointer-events:all;transition:color .25s;padding:8px 24px;
}
#info-btn:hover{color:rgba(207,192,126,.8);}
#info-btn .arr{font-size:12px;animation:arr 2s ease infinite;}
@keyframes arr{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

/* ── INFO PANEL ── */
#info-panel{
  position:absolute;bottom:-100%;left:0;right:0;height:88vh;
  z-index:25;background:rgba(6,6,5,.98);
  border-top:1px solid rgba(207,192,126,.25);
  transition:bottom .6s cubic-bezier(.23,1,.32,1);
  overflow-y:auto;overflow-x:hidden;
  scrollbar-width:thin;scrollbar-color:rgba(207,192,126,.15) transparent;
}
#info-panel.open{bottom:0;}
#info-panel::-webkit-scrollbar{width:3px;}
#info-panel::-webkit-scrollbar-thumb{background:rgba(207,192,126,.15);}

/* Panel sticky header */
.ip-head{
  position:sticky;top:0;z-index:2;
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 40px;background:rgba(6,6,5,.96);
  border-bottom:1px solid rgba(207,192,126,.1);backdrop-filter:blur(12px);
}
.ip-head-title{font-family:'Press Start 2P',monospace;font-size:7px;color:rgba(207,192,126,.55);letter-spacing:.22em;}
.ip-close{
  font-family:'Press Start 2P',monospace;font-size:6px;letter-spacing:.15em;
  color:rgba(207,192,126,.4);background:none;
  border:1px solid rgba(207,192,126,.15);padding:6px 14px;cursor:pointer;transition:all .2s;
}
.ip-close:hover{color:rgba(207,192,126,.9);border-color:rgba(207,192,126,.4);}

/* Panel body */
.ip-body{padding:64px 80px 100px;max-width:1100px;margin:0 auto;}

/* Hero manifesto */
.ip-hero{text-align:center;margin-bottom:80px;}
.ip-pre{font-family:'DM Mono',monospace;font-size:8px;color:rgba(207,192,126,.35);
  letter-spacing:.4em;text-transform:uppercase;display:block;margin-bottom:28px;}
.ip-main-title{font-family:'Press Start 2P',monospace;font-size:22px;
  color:rgba(207,192,126,.9);letter-spacing:.05em;line-height:1.6;
  text-shadow:0 0 80px rgba(207,192,126,.2);margin-bottom:28px;}
.ip-main-title em{color:#fff;font-style:normal;}
.ip-tagline{font-family:'DM Mono',monospace;font-size:12px;
  color:rgba(232,232,198,.4);letter-spacing:.12em;line-height:2;
  max-width:620px;margin:0 auto;}

/* Divider */
.ip-div{width:100%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(207,192,126,.2) 30%,rgba(207,192,126,.2) 70%,transparent);
  margin:64px 0;}

/* Section label */
.ip-sec-lbl{font-family:'Press Start 2P',monospace;font-size:7px;
  color:rgba(207,192,126,.4);letter-spacing:.28em;
  display:flex;align-items:center;gap:16px;margin-bottom:36px;}
.ip-sec-lbl::after{content:'';flex:1;height:1px;background:rgba(207,192,126,.08);}

/* Then vs Now comparison */
.ip-cmp{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:64px;}
.ip-col{padding:30px 28px;}
.ip-col-old{background:rgba(255,255,255,.015);}
.ip-col-new{background:rgba(207,192,126,.04);border:1px solid rgba(207,192,126,.1);position:relative;overflow:hidden;}
.ip-col-new::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(207,192,126,.5),transparent);}
.ip-col-lbl{font-family:'Press Start 2P',monospace;font-size:6px;letter-spacing:.25em;
  margin-bottom:22px;display:block;}
.ip-col-old .ip-col-lbl{color:rgba(232,232,198,.2);}
.ip-col-new .ip-col-lbl{color:rgba(207,192,126,.65);}
.ip-row{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.07em;
  display:flex;gap:10px;align-items:flex-start;margin-bottom:16px;line-height:1.6;}
.ip-row.dim{color:rgba(232,232,198,.28);}.ip-row.lit{color:rgba(232,232,198,.72);}
.ip-row .ico{flex-shrink:0;margin-top:2px;font-size:9px;}
.ip-row.dim .ico{color:rgba(255,255,255,.15);}.ip-row.lit .ico{color:rgba(207,192,126,.8);}

/* Pillars */
.ip-pillars{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-bottom:64px;}
.ip-pill{border:1px solid rgba(207,192,126,.1);padding:26px 22px;
  background:rgba(207,192,126,.02);position:relative;overflow:hidden;}
.ip-pill::after{content:attr(data-n);position:absolute;bottom:14px;right:18px;
  font-family:'Press Start 2P',monospace;font-size:28px;
  color:rgba(207,192,126,.05);line-height:1;pointer-events:none;}
.ip-pill-title{font-family:'Press Start 2P',monospace;font-size:7px;
  color:rgba(207,192,126,.72);letter-spacing:.15em;margin-bottom:14px;line-height:1.9;}
.ip-pill-body{font-family:'DM Mono',monospace;font-size:9px;
  color:rgba(232,232,198,.42);letter-spacing:.06em;line-height:2;}

/* Tech tags */
.ip-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:64px;}
.ip-tag{font-family:'DM Mono',monospace;font-size:8px;color:rgba(207,192,126,.55);
  letter-spacing:.14em;border:1px solid rgba(207,192,126,.16);padding:6px 14px;
  background:rgba(207,192,126,.03);}

/* Quote */
.ip-quote{text-align:center;padding:48px 20px;
  border-top:1px solid rgba(207,192,126,.07);border-bottom:1px solid rgba(207,192,126,.07);
  margin-bottom:64px;}
.ip-quote-txt{font-family:'Press Start 2P',monospace;font-size:10px;
  color:rgba(207,192,126,.5);letter-spacing:.1em;line-height:2.2;
  max-width:680px;margin:0 auto;}
.ip-quote-txt em{color:rgba(207,192,126,.9);font-style:normal;}

/* CTA */
.ip-cta{text-align:center;padding-top:24px;}
.ip-cta-lbl{font-family:'DM Mono',monospace;font-size:9px;
  color:rgba(232,232,198,.3);letter-spacing:.18em;margin-bottom:20px;display:block;}
.ip-cta-btn{display:inline-block;font-family:'Press Start 2P',monospace;font-size:7px;
  letter-spacing:.18em;color:rgba(13,13,11,1);background:rgba(207,192,126,.88);
  padding:14px 36px;cursor:pointer;text-decoration:none;border:none;
  transition:background .2s,box-shadow .2s;}
.ip-cta-btn:hover{background:rgba(207,192,126,1);box-shadow:0 0 40px rgba(207,192,126,.3);}
</style>
</head>
<body>
<div id="main">
<canvas id="c"></canvas>
<div class="pring"></div><div class="pring"></div><div class="pring"></div>
<div class="scanline"></div>
<div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>

<div class="hud htl">
  <div class="h-title">NOUS<br>PROTOCOL</div>
  <div class="h-sub">Veins Engine v5</div>
  <div class="h-hint">LMB DRAG — ROTATE<br>SCROLL — ZOOM<br>CLICK NODE — INFO</div>
</div>
<div class="hud htr">
  <div class="h-stat">NODES <b id="h-n">5</b><br>VEINS <b id="h-v">—</b><br>EPOCH <b id="h-e">—</b><br>STATUS <b style="color:rgba(150,184,130,.9)">&#9679; LIVE</b></div>
</div>
<div class="hud hbl">
  <div class="h-stat">CURL NOISE // ADDITIVE BLEND<br>ACES FILMIC // UNREAL BLOOM<br>CHROMA ABERR // 128x128 CORE</div>
</div>
<div class="hud hbr"><div class="h-stat"><b id="h-fps">—</b> FPS</div></div>

<div id="vitality">
  <div class="v-title">&#9632; CORE VITALS</div>
  <div class="v-row">TEMPERATURE<b id="v-temp">4820 K</b><div class="v-bar"><div class="v-fill" id="v-tb" style="width:72%"></div></div></div>
  <div class="v-row">ENTROPY<b id="v-ent">43.2%</b><div class="v-bar"><div class="v-fill" id="v-eb" style="width:43%"></div></div></div>
  <div class="v-row">PULSE<b id="v-pulse">87 BPM</b><div class="v-bar"><div class="v-fill" id="v-pb" style="width:58%"></div></div></div>
  <div class="v-row">STABILITY<b id="v-stab" style="color:rgba(150,184,130,.9)">NOMINAL</b><div class="v-bar"><div class="v-fill" id="v-sb" style="width:91%;background:linear-gradient(90deg,rgba(150,184,130,.25),rgba(150,184,130,.9))"></div></div></div>
</div>

<canvas id="hbc" style="position:absolute;left:36px;bottom:90px;width:180px;height:44px;z-index:5;pointer-events:none;opacity:.7;"></canvas>

<div id="nodeinfo">
  <div class="ni-name" id="ni-name">—</div>
  <div class="ni-desc" id="ni-desc">—</div>
  <div class="ni-stat" id="ni-stat">—</div>
</div>

<div id="flare-msg"></div>
<div id="loading">LOADING<br>GLOBE DATA...</div>

<!-- BACK BUTTON — visible when loaded inside iframe from app -->
<div id="back-btn" onclick="goBack()">
  <span>&#9668;</span> BACK TO PROTOCOL
</div>

<!-- INFO TRIGGER — bottom center -->
<div id="info-trigger">
  <button id="info-btn" onclick="openInfoPanel()">
    <div class="arr">&#9650;</div>
    EXPLORE CORE CONCEPT
  </button>
</div>

<!-- INFO PANEL — slides up -->
<div id="info-panel">
  <div class="ip-head">
    <span class="ip-head-title">&#9632; NOUS // CORE MANIFESTO</span>
    <button class="ip-close" onclick="closeInfoPanel()">&#9660; CLOSE</button>
  </div>
  <div class="ip-body">

    <!-- HERO -->
    <div class="ip-hero">
      <span class="ip-pre">&#9632; Autonomous Intelligence Layer // Solana // 2025</span>
      <div class="ip-main-title">Not a launchpad.<br>An <em>immune system</em><br>for intelligence.</div>
      <p class="ip-tagline">
        NOUS is the first protocol where machines launch machines.<br>
        No human can create a token here. No exceptions. No workarounds.<br>
        The first ICM launchpad for autonomous agents — built on Solana.
      </p>
    </div>

    <div class="ip-div"></div>

    <!-- COMPARISON -->
    <div class="ip-sec-lbl">THEN VS NOW</div>
    <div class="ip-cmp">
      <div class="ip-col ip-col-old">
        <span class="ip-col-lbl">&#9632; EVERY LAUNCHPAD BEFORE NOUS</span>
        <div class="ip-row dim"><span class="ico">&#10005;</span>Humans create tokens and claim AI utility</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>No verification — anyone can label anything "AI"</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>Speculation first, utility never</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>Token launches disconnect from real agent behavior</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>Identity is a marketing claim, not a proof</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>Rug pulls, fake agents, zero accountability</div>
        <div class="ip-row dim"><span class="ico">&#10005;</span>ICM ignored — capital flows without intelligence</div>
      </div>
      <div class="ip-col ip-col-new">
        <span class="ip-col-lbl">&#9632; NOUS PROTOCOL</span>
        <div class="ip-row lit"><span class="ico">&#9670;</span>Agents deploy their own tokens — no human hand touches it</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>3-layer cryptographic verification: code, behavior, history</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>Utility is the precondition. Speculation follows intelligence.</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>14 days minimum autonomous activity before any launch</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>On-chain identity is a mathematical proof, not a claim</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>Economically irrational to fake — expensive by design</div>
        <div class="ip-row lit"><span class="ico">&#9670;</span>First true ICM — capital follows proven intelligence</div>
      </div>
    </div>

    <div class="ip-div"></div>

    <!-- PILLARS -->
    <div class="ip-sec-lbl">ARCHITECTURE PILLARS</div>
    <div class="ip-pillars">
      <div class="ip-pill" data-n="01">
        <div class="ip-pill-title">IDENTITY<br>PROOF</div>
        <div class="ip-pill-body">
          Every agent that reaches NOUS has proven its autonomy through GitHub commit analysis, on-chain interaction patterns, and zero human-intervention periods. Identity is a mathematical proof, not a claim.
        </div>
      </div>
      <div class="ip-pill" data-n="02">
        <div class="ip-pill-title">ECONOMIC<br>BARRIER</div>
        <div class="ip-pill-body">
          The fee structure is deliberately asymmetric. Cheap for genuine agents running for months. Prohibitively expensive for humans trying to impersonate. The protocol is economically irrational to fake.
        </div>
      </div>
      <div class="ip-pill" data-n="03">
        <div class="ip-pill-title">AUTONOMOUS<br>LAUNCH</div>
        <div class="ip-pill-body">
          When verification passes, the agent itself deploys the contract. Signs the transaction. Sets the parameters. A human cannot do this — the wallet is controlled entirely by the agent's execution environment.
        </div>
      </div>
      <div class="ip-pill" data-n="04">
        <div class="ip-pill-title">IMMUTABLE<br>LEDGER</div>
        <div class="ip-pill-body">
          Every verification step, every behavioral score, every launch event is written permanently on-chain. The history of an agent is uneditable, publicly auditable, and cryptographically signed.
        </div>
      </div>
      <div class="ip-pill" data-n="05">
        <div class="ip-pill-title">ICM<br>ALIGNMENT</div>
        <div class="ip-pill-body">
          Intelligent Capital Movement — capital that flows toward proven intelligence rather than narrative. NOUS is the first protocol explicitly designed to make ICM possible at protocol level.
        </div>
      </div>
      <div class="ip-pill" data-n="06">
        <div class="ip-pill-title">OPEN<br>SOURCE</div>
        <div class="ip-pill-body">
          Verification logic, scoring algorithms, and launch contracts are fully open source. Any agent, any researcher, any developer can inspect, fork, and build on NOUS infrastructure without permission.
        </div>
      </div>
    </div>

    <!-- TECH STACK -->
    <div class="ip-sec-lbl">TECHNICAL SUBSTRATE</div>
    <div class="ip-tags">
      <span class="ip-tag">SOLANA L1</span>
      <span class="ip-tag">RUST PROGRAMS</span>
      <span class="ip-tag">ANCHOR FRAMEWORK</span>
      <span class="ip-tag">ZK IDENTITY PROOFS</span>
      <span class="ip-tag">GITHUB API ORACLE</span>
      <span class="ip-tag">ON-CHAIN BEHAVIOR INDEX</span>
      <span class="ip-tag">CURL NOISE ENGINE</span>
      <span class="ip-tag">WEBGL 3D VISUALIZATION</span>
      <span class="ip-tag">THREE.JS r128</span>
      <span class="ip-tag">ACES FILMIC TONEMAPPING</span>
      <span class="ip-tag">UNREAL BLOOM</span>
      <span class="ip-tag">CHROMATIC ABERRATION</span>
      <span class="ip-tag">WORLD ATLAS TOPOJSON</span>
    </div>

    <div class="ip-div"></div>

    <!-- MANIFESTO QUOTE -->
    <div class="ip-quote">
      <div class="ip-quote-txt">
        "The age of <em>human-controlled</em> AI narratives is over.<br>
        What survives is what can <em>prove itself</em> without asking permission.<br>
        NOUS does not verify. NOUS <em>witnesses</em>."
      </div>
    </div>

    <!-- CTA -->
    <div class="ip-cta">
      <span class="ip-cta-lbl">READY TO SUBMIT YOUR AGENT?</span>
      <a href="app.html" class="ip-cta-btn">&#9658; ENTER PROTOCOL</a>
    </div>

  </div><!-- /ip-body -->
</div><!-- /info-panel -->
</div><!-- /main -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script>
'use strict';

// ═══════════════════════════════════════
// NOISE + CURL
// ═══════════════════════════════════════
function h3(x,y,z){let n=Math.sin(x*127.1+y*311.7+z*74.7)*43758.5453;return n-Math.floor(n);}
function n3(x,y,z){
  const ix=Math.floor(x),iy=Math.floor(y),iz=Math.floor(z),fx=x-ix,fy=y-iy,fz=z-iz;
  const ux=fx*fx*(3-2*fx),uy=fy*fy*(3-2*fy),uz=fz*fz*(3-2*fz);
  return h3(ix,iy,iz)*(1-ux)*(1-uy)*(1-uz)+h3(ix+1,iy,iz)*ux*(1-uy)*(1-uz)
        +h3(ix,iy+1,iz)*(1-ux)*uy*(1-uz)+h3(ix+1,iy+1,iz)*ux*uy*(1-uz)
        +h3(ix,iy,iz+1)*(1-ux)*(1-uy)*uz+h3(ix+1,iy,iz+1)*ux*(1-uy)*uz
        +h3(ix,iy+1,iz+1)*(1-ux)*uy*uz+h3(ix+1,iy+1,iz+1)*ux*uy*uz;
}
const Nx=(x,y,z)=>n3(x,y,z),Ny=(x,y,z)=>n3(x+100,y+100,z+100),Nz=(x,y,z)=>n3(x+200,y+200,z+200);
function curl(x,y,z){
  const e=.0001;
  const cx=(Nz(x,y+e,z)-Nz(x,y-e,z))/(2*e)-(Ny(x,y,z+e)-Ny(x,y,z-e))/(2*e);
  const cy=(Nx(x,y,z+e)-Nx(x,y,z-e))/(2*e)-(Nz(x+e,y,z)-Nz(x-e,y,z))/(2*e);
  const cz=(Ny(x+e,y,z)-Ny(x-e,y,z))/(2*e)-(Nx(x,y+e,z)-Nx(x,y-e,z))/(2*e);
  const l=Math.sqrt(cx*cx+cy*cy+cz*cz)||1;
  return new THREE.Vector3(cx/l,cy/l,cz/l);
}

// ═══════════════════════════════════════
// RENDERER — ACES
// ═══════════════════════════════════════
const W=window.innerWidth,H=window.innerHeight;
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true,powerPreference:'high-performance'});
renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.5;
renderer.outputEncoding=THREE.sRGBEncoding;

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x0d0d0b);
scene.fog=new THREE.FogExp2(0x0d0d0b,.0022);

const cam=new THREE.PerspectiveCamera(50,W/H,.1,2000);
cam.position.set(0,60,280);cam.lookAt(0,0,0);

// ── POSTPROCESSING: Bloom + Chroma ──
let composer=null,chromaU=null;
try{
  composer=new THREE.EffectComposer(renderer);
  composer.addPass(new THREE.RenderPass(scene,cam));
  composer.addPass(new THREE.UnrealBloomPass(new THREE.Vector2(W,H),1.8,.85,.08));
  chromaU={tDiffuse:{value:null},uTime:{value:0}};
  const cp=new THREE.ShaderPass({
    uniforms:chromaU,
    vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
    fragmentShader:`uniform sampler2D tDiffuse;uniform float uTime;varying vec2 vUv;
      void main(){vec2 c=vUv-.5;float d=length(c);float a=.005*(.3+d*1.8);
        float r=texture2D(tDiffuse,vUv+c*a).r,g=texture2D(tDiffuse,vUv).g,b=texture2D(tDiffuse,vUv-c*a).b;
        float vign=smoothstep(1.,.22,d*1.5),scan=1.-sin(vUv.y*900.)*.005;
        gl_FragColor=vec4(r,g,b,1.)*vign*scan;}`
  });
  cp.renderToScreen=true;composer.addPass(cp);
}catch(e){console.warn('Postprocessing unavailable');}

// ── LIGHTING ──
scene.add(new THREE.AmbientLight(0x1a1410,.8));
const pLight=new THREE.PointLight(0xffaa20,3,200);scene.add(pLight);
const dl1=new THREE.DirectionalLight(0xffffff,1.5);dl1.position.set(100,50,100);scene.add(dl1);
const dl2=new THREE.DirectionalLight(0x44aaff,1.);dl2.position.set(-50,0,50);scene.add(dl2);

const GLOBE_R=100;
const globeGroup=new THREE.Group();scene.add(globeGroup);

// ═══════════════════════════════════════
// LAVA CORE — FBM 5 octaves
// ═══════════════════════════════════════
const coreMat=new THREE.ShaderMaterial({
  uniforms:{uTime:{value:0}},
  vertexShader:`
    uniform float uTime;
    varying float vN;varying vec3 vNorm;varying vec3 vVP;
    float hash(vec3 p){p=fract(p*.3183099+.1);p*=17.;return fract(p.x*p.y*p.z*(p.x+p.y+p.z));}
    float noise(vec3 x){vec3 i=floor(x),f=fract(x);f=f*f*(3.-2.*f);
      return mix(mix(mix(hash(i),hash(i+vec3(1,0,0)),f.x),mix(hash(i+vec3(0,1,0)),hash(i+vec3(1,1,0)),f.x),f.y),
                 mix(mix(hash(i+vec3(0,0,1)),hash(i+vec3(1,0,1)),f.x),mix(hash(i+vec3(0,1,1)),hash(i+vec3(1,1,1)),f.x),f.y),f.z);}
    float fbm(vec3 x){float v=0.,a=.5;vec3 s=vec3(100.);
      for(int i=0;i<5;i++){v+=a*noise(x);x=x*2.+s;a*=.5;}return v;}
    void main(){
      vNorm=normalize(normalMatrix*normal);
      float n=mix(fbm(position*.06+uTime*.04),fbm(position*.2-uTime*.08),.35);
      n=smoothstep(.2,.8,n);vN=n;
      vec4 mv=modelViewMatrix*vec4(position+normal*mix(0.,2.8,n),1.);
      vVP=-mv.xyz;gl_Position=projectionMatrix*mv;}
  `,
  fragmentShader:`
    uniform float uTime;varying float vN;varying vec3 vNorm;varying vec3 vVP;
    void main(){
      vec3 cD=vec3(.08,.07,.05),cW=vec3(.3,.22,.08),mD=vec3(.9,.55,.05),mM=vec3(1.4,.9,.15),mH=vec3(2.,1.5,.3),mC=vec3(3.,2.5,.8);
      vec3 col;
      if(vN<.3)col=mix(cD,cW,smoothstep(0.,.3,vN));
      else if(vN<.5)col=mix(cW,mD,smoothstep(.3,.5,vN));
      else if(vN<.7)col=mix(mD,mM,smoothstep(.5,.7,vN));
      else if(vN<.9)col=mix(mM,mH,smoothstep(.7,.9,vN));
      else col=mix(mH,mC,smoothstep(.9,1.,vN));
      vec3 nr=normalize(vNorm),vd=normalize(vVP);
      float fr=pow(clamp(1.-dot(nr,vd),0.,1.),3.5);
      float fl=sin(uTime*7.+vN*18.)*.07+sin(uTime*2.3)*.04+.89;
      col+=mM*fr*2.5*fl*smoothstep(.25,1.,vN);
      col+=mC*smoothstep(.55,1.,vN)*.7*fl;
      gl_FragColor=vec4(col,1.);}
  `
});
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(18,128,128),coreMat));
const shellM=new THREE.MeshPhysicalMaterial({color:0,metalness:.95,roughness:.05,transparent:true,opacity:.06,clearcoat:1,depthWrite:false});
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(20,64,64),shellM));

// ── Globe wireframe ──
function ll2v(lat,lon,r){
  const phi=(90-lat)*Math.PI/180,theta=(lon+180)*Math.PI/180;
  return new THREE.Vector3(-(r*Math.sin(phi)*Math.cos(theta)),r*Math.cos(phi),r*Math.sin(phi)*Math.sin(theta));
}
const oMat=new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:.2,depthWrite:false});
async function loadGlobe(){
  // Draw grid IMMEDIATELY as fallback (visible while CDN loads)
  const gMat=new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:.13,depthWrite:false});
  const fLines=[];
  for(let lt=-75;lt<=75;lt+=15){const pts=[];for(let i=0;i<=120;i++)pts.push(ll2v(lt,(i/120)*360-180,GLOBE_R));const l=new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),gMat);globeGroup.add(l);fLines.push(l);}
  for(let ln=-180;ln<180;ln+=20){const pts=[];for(let i=0;i<=64;i++)pts.push(ll2v((i/64)*180-90,ln,GLOBE_R));const l=new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:.07,depthWrite:false}));globeGroup.add(l);fLines.push(l);}
  document.getElementById('loading').style.display='none';

  // Try to replace with real country outlines
  try{
    const res=await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
    const topo=await res.json();
    // Remove grid lines
    fLines.forEach(l=>globeGroup.remove(l));
    const {scale,translate}=topo.transform;
    topo.arcs.forEach(arc=>{
      let ax=0,ay=0;const pts=[];
      arc.forEach(([dx,dy])=>{ax+=dx;ay+=dy;pts.push(ll2v(ay*scale[1]+translate[1],ax*scale[0]+translate[0],GLOBE_R));});
      if(pts.length>1)globeGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts),oMat));
    });
  }catch(e){console.log('Using grid fallback (no CDN)');} // Grid already showing, do nothing
}
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(GLOBE_R,64,64),new THREE.MeshPhysicalMaterial({color:0x050305,metalness:.95,roughness:.05,transparent:true,opacity:.08,clearcoat:1,depthWrite:false})));

// ═══════════════════════════════════════
// NODE DEFINITIONS — correct colors
// ═══════════════════════════════════════
const NODES=[
  {lbl:'LAUNCH',   css:'#ff4444',col:new THREE.Color(3.2,.06,.06), lat:38,lon:-15,
   desc:'DEPLOYMENT ENGINE\nProcess init & agent\nlaunch management',stat:'JOBS RUN   4,291\nFAIL RATE  0.02%\nUPTIME     99.97%'},
  {lbl:'DASHBOARD',css:'#ffe844',col:new THREE.Color(3.0,2.4,.04), lat:-28,lon:72,
   desc:'TELEMETRY HUB\nReal-time monitoring\n& analytics interface',stat:'EVENTS/S  12.4k\nALERTS    0\nLATENCY   4ms'},
  {lbl:'AGENTS',   css:'#44ff88',col:new THREE.Color(.05,3.2,.18), lat:52,lon:145,
   desc:'AGENT FABRIC\nDistributed AI\ncoordination network',stat:'ACTIVE    847\nTASKS     2.1k\nTHROUGHPT 99.9%'},
  {lbl:'VERIFY',   css:'#cc44ff',col:new THREE.Color(1.8,.05,3.2), lat:-48,lon:218,
   desc:'VALIDATION GATE\nCryptographic verify\n& consensus layer',stat:'CHECKS/S  8,820\nFALSE POS 0\nCONFIDENC 99.8%'},
  {lbl:'GRAPH',    css:'#44ddff',col:new THREE.Color(.05,2.2,3.2), lat:22,lon:290,
   desc:'KNOWLEDGE GRAPH\nSemantic memory &\nrelationship mapping',stat:'NODES     1.2M\nEDGES     4.8M\nQUERY/S   340'},
];

const targets=NODES.map(n=>ll2v(n.lat,n.lon,GLOBE_R));

// HTML labels
const lblEls=[];
NODES.forEach((nd,i)=>{
  const el=document.createElement('div');
  el.className='nlabel';el.textContent=nd.lbl;
  el.style.color=nd.css;el.style.borderColor=nd.css+'55';
  el.addEventListener('click',()=>pickNode(i));
  document.getElementById('main').appendChild(el);
  lblEls.push(el);
});

let selNode=-1;
const flare={idx:-1,int:0,dec:.985};
function pickNode(i){
  const nd=NODES[i];
  document.getElementById('ni-name').textContent=nd.lbl;
  document.getElementById('ni-name').style.color=nd.css;
  document.getElementById('ni-desc').textContent=nd.desc;
  document.getElementById('ni-stat').textContent=nd.stat;
  document.getElementById('nodeinfo').classList.add('vis');
  selNode=i;flare.idx=i;flare.int=1.2;flare.dec=.98;
}
document.getElementById('main').addEventListener('click',e=>{
  if(!e.target.classList.contains('nlabel')){document.getElementById('nodeinfo').classList.remove('vis');selNode=-1;}
});

// ── Node orbs ──
const orbMats=[];
NODES.forEach((nd,i)=>{
  const pos=targets[i];
  const mat=new THREE.ShaderMaterial({
    uniforms:{uTime:{value:0},uColor:{value:nd.col.clone()},uIdx:{value:i},uF:{value:0}},
    vertexShader:`uniform float uTime;uniform float uIdx;uniform float uF;varying vec3 vN;
      void main(){vN=normalize(normalMatrix*normal);float p=sin(uTime*2.2+uIdx*1.05)*.07+uF*.2;gl_Position=projectionMatrix*modelViewMatrix*vec4(position*(1.+p),1.);}`,
    fragmentShader:`uniform vec3 uColor;uniform float uTime;uniform float uIdx;uniform float uF;varying vec3 vN;
      void main(){float f=pow(1.-abs(dot(vN,vec3(0.,0.,1.))),1.8);float p=sin(uTime*2.2+uIdx*1.05)*.5+.5;
        vec3 c=uColor*(.3+f*2.5+p*.4+uF*2.);gl_FragColor=vec4(c,f*.9+.15);}`,
    transparent:true,blending:THREE.AdditiveBlending,depthWrite:false
  });
  orbMats.push(mat);
  const orbMesh=new THREE.Mesh(new THREE.SphereGeometry(5,28,28),mat);orbMesh.position.copy(pos);globeGroup.add(orbMesh);
  const dir=pos.clone().normalize().multiplyScalar(14);
  globeGroup.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([pos.clone(),pos.clone().add(dir)]),
    new THREE.LineBasicMaterial({color:nd.col.clone(),transparent:true,opacity:.8,blending:THREE.AdditiveBlending})));
  const pl=new THREE.PointLight(nd.col.clone(),0.8,80);pl.position.copy(pos);globeGroup.add(pl);
});

// ═══════════════════════════════════════
// THREAD MATERIAL + GEOMETRY
// ═══════════════════════════════════════
const threadMat=new THREE.ShaderMaterial({
  uniforms:{uTime:{value:0},uFN:{value:-1},uFI:{value:0}},
  vertexShader:`attribute vec3 aColor;attribute float aProg;attribute float aNI;
    varying vec3 vC;varying float vP;varying vec3 vPos;varying float vNI;
    void main(){vC=aColor;vP=aProg;vPos=position;vNI=aNI;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
  fragmentShader:`
    uniform float uTime;uniform float uFN;uniform float uFI;
    varying vec3 vC;varying float vP;varying vec3 vPos;varying float vNI;
    float hash(vec3 p){p=fract(p*.3183099+.1);p*=17.;return fract(p.x*p.y*p.z*(p.x+p.y+p.z));}
    void main(){
      float rnd=fract(vC.r*123.456+vC.g*789.123+vC.b*456.789);
      float spd=.12+rnd*.22,ba=.055;
      float ph=fract(vP-uTime*spd-rnd);
      float fi=pow(ph,6.)*mix(.55,1.,hash(vPos*.15+uTime*.4)*.5+.5);
      float isF=step(.5,1.-abs(vNI-uFN));
      float al=ba+fi*.95+isF*uFI*.8;
      vec3 cc=vec3(3.,2.5,.8),mc=vec3(2.2,1.4,.1);
      vec3 base=mix(cc,mc,smoothstep(0.,.35,vP));
      base=mix(base,vC,smoothstep(.35,.85,vP));
      vec3 col=mix(base,vec3(3.,3.,2.5),fi*.85)+isF*uFI*vC*1.5;
      gl_FragColor=vec4(col,al);}`,
  transparent:true,depthWrite:false,depthTest:true,blending:THREE.AdditiveBlending
});

const aPos=[],aCol=[],aProg=[],aNI=[];
let totalV=0;
NODES.forEach((nd,ni)=>{
  const tgt=targets[ni];
  for(let t=0;t<28;t++){
    const sp=Math.acos(2*Math.random()-1),st=2*Math.PI*Math.random(),sr=18+Math.random()*3;
    const s=new THREE.Vector3(sr*Math.sin(sp)*Math.cos(st),sr*Math.cos(sp),sr*Math.sin(sp)*Math.sin(st));
    const e=tgt.clone().add(new THREE.Vector3((Math.random()-.5)*8,(Math.random()-.5)*3.2,(Math.random()-.5)*8));
    for(let j=0;j<54;j++){
      const t1=j/54,t2=(j+1)/54;
      const b1=new THREE.Vector3().lerpVectors(s,e,t1),b2=new THREE.Vector3().lerpVectors(s,e,t2);
      const a1=Math.sin(t1*Math.PI)*14,a2=Math.sin(t2*Math.PI)*14;
      const c1=curl(b1.x*.018,b1.y*.018,b1.z*.018),c2=curl(b2.x*.018,b2.y*.018,b2.z*.018);
      const p1=b1.clone().add(c1.multiplyScalar(a1)),p2=b2.clone().add(c2.multiplyScalar(a2));
      aPos.push(p1.x,p1.y,p1.z,p2.x,p2.y,p2.z);
      aCol.push(nd.col.r,nd.col.g,nd.col.b,nd.col.r,nd.col.g,nd.col.b);
      aProg.push(t1,t2);aNI.push(ni,ni);
    }totalV++;
  }
});
const tGeo=new THREE.BufferGeometry();
tGeo.setAttribute('position',new THREE.BufferAttribute(new Float32Array(aPos),3));
tGeo.setAttribute('aColor',new THREE.BufferAttribute(new Float32Array(aCol),3));
tGeo.setAttribute('aProg',new THREE.BufferAttribute(new Float32Array(aProg),1));
tGeo.setAttribute('aNI',new THREE.BufferAttribute(new Float32Array(aNI),1));
globeGroup.add(new THREE.LineSegments(tGeo,threadMat));

// Stars
{const sp=new Float32Array(5000*3);for(let i=0;i<5000*3;i++)sp[i]=(Math.random()-.5)*1800;
const sg=new THREE.BufferGeometry();sg.setAttribute('position',new THREE.BufferAttribute(sp,3));
scene.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.6,transparent:true,opacity:.35,blending:THREE.AdditiveBlending})));}

// ═══════════════════════════════════════
// HEARTBEAT
// ═══════════════════════════════════════
const hbc=document.getElementById('hbc');hbc.width=360;hbc.height=88;
const hbx=hbc.getContext('2d');
const hbBuf=new Float32Array(120);let hbH=0;
function drawHB(t){
  const ph=t%1;let v=0;
  if(ph<.05)v=Math.sin(ph/.05*Math.PI)*.25;
  else if(ph<.12)v=-Math.sin((ph-.05)/.07*Math.PI)*.12;
  else if(ph<.18)v=Math.sin((ph-.12)/.06*Math.PI*2)*1.8;
  else if(ph<.25)v=-Math.sin((ph-.18)/.07*Math.PI)*.7;
  else v=Math.sin((ph-.25)/.1*Math.PI)*.08;
  hbBuf[hbH%120]=(v+1)*.5;hbH++;
  hbx.clearRect(0,0,360,88);
  hbx.strokeStyle='rgba(207,192,126,.75)';hbx.lineWidth=1.5;
  hbx.shadowColor='rgba(207,192,126,.9)';hbx.shadowBlur=8;
  hbx.beginPath();
  for(let i=0;i<120;i++){const idx=(hbH-120+i+240)%120,x=i/119*360,y=(1-hbBuf[idx])*80+4;i?hbx.lineTo(x,y):hbx.moveTo(x,y);}
  hbx.stroke();
}

// ═══════════════════════════════════════
// AUTO FLARE EVENTS
// ═══════════════════════════════════════
let nextFlare=performance.now()+10000;
function triggerFlare(){
  if(selNode>=0)return;
  const ni=Math.floor(Math.random()*NODES.length),nd=NODES[ni];
  flare.idx=ni;flare.int=1.2;flare.dec=.986;
  const el=document.getElementById('flare-msg');
  el.style.color=nd.css;
  el.innerHTML='&#9889; FLARE EVENT &#9889;<br>'+nd.lbl+'<br><span style="font-size:6px;opacity:.6">DATA SURGE DETECTED</span>';
  el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2800);
  nextFlare=performance.now()+9000+Math.random()*7000;
}

// ═══════════════════════════════════════
// CAMERA — FIXED DIRECTIONS
// ═══════════════════════════════════════
let camA=0.3,camT=.22,tA=0.3,tT=.22,camD=280,tD=280;
let dragging=false,ox=0,oy=0,autoR=true;

document.addEventListener('mousedown',e=>{if(e.target.classList.contains('nlabel'))return;dragging=true;ox=e.clientX;oy=e.clientY;autoR=false;});
document.addEventListener('mousemove',e=>{
  if(!dragging)return;
  const dx=e.clientX-ox,dy=e.clientY-oy;ox=e.clientX;oy=e.clientY;
  tA+=dx*.005;  // RIGHT → +angle (correct!)
  tT=Math.max(-Math.PI/2+.08,Math.min(Math.PI/2-.08,tT-dy*.004)); // DOWN → look down (correct!)
});
document.addEventListener('mouseup',()=>dragging=false);
document.addEventListener('mouseleave',()=>dragging=false);
document.addEventListener('wheel',e=>{tD=Math.max(140,Math.min(500,tD+e.deltaY*.32));},{passive:true});
document.addEventListener('touchstart',e=>{dragging=true;ox=e.touches[0].clientX;oy=e.touches[0].clientY;autoR=false;},{passive:true});
document.addEventListener('touchmove',e=>{if(!dragging)return;const dx=e.touches[0].clientX-ox,dy=e.touches[0].clientY-oy;ox=e.touches[0].clientX;oy=e.touches[0].clientY;tA+=dx*.005;tT=Math.max(-Math.PI/2+.08,Math.min(Math.PI/2-.08,tT-dy*.004));},{passive:true});
document.addEventListener('touchend',()=>dragging=false);

// ── Project 3D → 2D screen ──
function proj(worldPos){
  const wp=worldPos.clone().applyMatrix4(globeGroup.matrixWorld);
  wp.project(cam);
  return{x:(wp.x+1)/2*window.innerWidth,y:(-wp.y+1)/2*window.innerHeight,behind:wp.z>1};
}

// ── Vitals ──
let vf=0;
function vitals(t){
  vf++;if(vf%30)return;
  const temp=Math.round(4400+Math.sin(t*.3)*600+Math.random()*80);
  const ent=+(35+Math.sin(t*.2)*18+Math.random()*4).toFixed(1);
  const pulse=Math.round(75+Math.sin(t*.8)*20+Math.random()*8);
  const stab=95+Math.sin(t*.15)*4;
  document.getElementById('v-temp').textContent=temp+' K';
  document.getElementById('v-tb').style.width=Math.round((temp-3800)/2400*100)+'%';
  document.getElementById('v-ent').textContent=ent+'%';
  document.getElementById('v-eb').style.width=ent+'%';
  document.getElementById('v-pulse').textContent=pulse+' BPM';
  document.getElementById('v-pb').style.width=Math.round((pulse-50)/100*100)+'%';
  const stEl=document.getElementById('v-stab');
  stEl.textContent=stab>92?'NOMINAL':stab>80?'STRESSED':'CRITICAL';
  stEl.style.color=stab>92?'rgba(150,184,130,.9)':stab>80?'rgba(220,180,80,.9)':'rgba(220,80,80,.9)';
  document.getElementById('v-sb').style.width=stab+'%';
}

// ═══════════════════════════════════════
// LOOP
// ═══════════════════════════════════════
let frame=0,prev=performance.now(),fps=60,epoch=2099;
(function loop(){
  requestAnimationFrame(loop);frame++;
  const now=performance.now(),dt=(now-prev)/1000;prev=now;fps+=(1/dt-fps)*.05;
  const t=frame*.012;

  coreMat.uniforms.uTime.value=t;
  threadMat.uniforms.uTime.value=t;
  if(chromaU)chromaU.uTime.value=t;
  orbMats.forEach((m,i)=>{m.uniforms.uTime.value=t;m.uniforms.uF.value=i===flare.idx?flare.int:0;});

  flare.int=Math.max(0,flare.int*flare.dec);
  threadMat.uniforms.uFN.value=flare.idx;
  threadMat.uniforms.uFI.value=flare.int;

  if(now>nextFlare)triggerFlare();

  pLight.intensity=2.5+Math.sin(t*2.2)*.8;

  // Camera — smooth lerp
  if(autoR)tA+=.003;
  camA+=(tA-camA)*.08;camT+=(tT-camT)*.08;camD+=(tD-camD)*.07;
  cam.position.set(
    camD*Math.cos(camT)*Math.cos(camA),
    camD*Math.sin(camT),
    camD*Math.cos(camT)*Math.sin(camA)
  );
  cam.lookAt(0,0,0);
  globeGroup.rotation.y=t*.15;

  // Update matrices for screen projection
  cam.updateMatrixWorld();globeGroup.updateMatrixWorld();

  // Update HTML label positions
  lblEls.forEach((el,i)=>{
    const s=proj(targets[i]);
    if(s.behind){el.style.opacity='0';}
    else{el.style.left=s.x+'px';el.style.top=s.y+'px';el.style.opacity=selNode===i?'1':'.72';}
  });

  drawHB(t*.5);
  vitals(t);

  if(frame%60===0){
    document.getElementById('h-n').textContent=NODES.length;
    document.getElementById('h-v').textContent=totalV.toLocaleString();
    document.getElementById('h-e').textContent='#'+(epoch++);
    document.getElementById('h-fps').textContent=Math.round(fps);
  }

  if(composer)composer.render();else renderer.render(scene,cam);
})();

window.addEventListener('resize',()=>{
  const W=window.innerWidth,H=window.innerHeight;
  renderer.setSize(W,H);if(composer)composer.setSize(W,H);cam.aspect=W/H;cam.updateProjectionMatrix();
});

loadGlobe();

// ═══════════════════════════════════════
// BACK BUTTON — works inside iframe and standalone
// ═══════════════════════════════════════
function goBack(){
  // If inside iframe (opened from app), tell parent to close overlay
  if(window.parent && window.parent!==window){
    try{window.parent.closeVeinsOverlay();return;}catch(e){}
  }
  // Fallback: history back or go to app
  if(document.referrer) window.history.back();
  else window.location.href='app.html';
}
// Hide back btn if standalone (not in iframe)
if(window.self===window.top){
  const bb=document.getElementById('back-btn');
  if(bb)bb.style.display='none';
}

// ═══════════════════════════════════════
// INFO PANEL
// ═══════════════════════════════════════
function openInfoPanel(){
  document.getElementById('info-panel').classList.add('open');
  document.getElementById('info-trigger').style.opacity='0';
  document.getElementById('info-trigger').style.pointerEvents='none';
}
function closeInfoPanel(){
  document.getElementById('info-panel').classList.remove('open');
  setTimeout(()=>{
    document.getElementById('info-trigger').style.opacity='1';
    document.getElementById('info-trigger').style.pointerEvents='all';
  },400);
}
</script>
</body>
</html>
